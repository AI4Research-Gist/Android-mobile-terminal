<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI4Research</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    /* Global Font Settings */
    body {
      font-family: 'Inter', sans-serif;
    }

    h1,
    h2,
    h3,
    h4,
    .font-display {
      font-family: 'Space Grotesk', sans-serif;
    }

    /* Critical: Hide content until fully loaded */
    #root {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    #root.loaded {
      opacity: 1;
    }

    /* Inline loading screen - no external dependencies */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: #F2F2F7;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out;
    }

    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(16, 185, 129, 0.2);
      border-top-color: #10B981;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: #64748b;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes grid-move {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(40px);
      }
    }

    .animate-grid {
      animation: grid-move 20s linear infinite;
    }

    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
      user-select: none;
      margin: 0;
      padding: 0;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Liquid Glass Effect Styles */
    .liquid-glass {
      position: relative;
      overflow: hidden;
    }

    .liquid-glass::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.4) 0%,
          rgba(255, 255, 255, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 100%);
      pointer-events: none;
      z-index: 1;
    }

    .liquid-glass-dark::before {
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.15) 0%,
          rgba(255, 255, 255, 0.05) 50%,
          rgba(255, 255, 255, 0.02) 100%);
    }

    /* Edge highlight for glass refraction effect */
    .liquid-glass::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.6) 0%,
          rgba(255, 255, 255, 0.2) 30%,
          transparent 60%,
          rgba(255, 255, 255, 0.1) 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
      z-index: 2;
    }

    .liquid-glass-dark::after {
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.25) 0%,
          rgba(255, 255, 255, 0.1) 30%,
          transparent 60%,
          rgba(16, 185, 129, 0.15) 100%);
    }
  </style>
  <!-- Import dependencies as modules and expose to window for Babel script -->
  <script type="module">
    import React from 'https://esm.sh/react@18.2.0';
    import * as ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import * as FramerMotion from 'https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0';
    import * as LucideReact from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';

    window.React = React;
    window.ReactDOM = ReactDOM;
    window.FramerMotion = FramerMotion;
    window.LucideReact = LucideReact;

    // Signal that dependencies are loaded
    window.dispatchEvent(new Event('deps-loaded'));
  </script>
</head>

<body class="bg-[#F2F2F7] text-white h-screen w-screen overflow-hidden">
  <!-- SVG Filters for Liquid Glass Effect -->
  <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" style="position:absolute;">
    <defs>
      <!-- Light mode liquid glass filter -->
      <filter id="liquid-glass-light" x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox"
        colorInterpolationFilters="sRGB">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" result="blur" />
        <feColorMatrix in="blur" type="matrix" values="1 0 0 0 0.02  0 1 0 0 0.02  0 0 1 0 0.02  0 0 0 1 0"
          result="brighten" />
        <feComposite in="brighten" in2="SourceGraphic" operator="over" />
      </filter>

      <!-- Dark mode liquid glass filter with subtle glow -->
      <filter id="liquid-glass-dark" x="-50%" y="-50%" width="200%" height="200%" filterUnits="objectBoundingBox"
        colorInterpolationFilters="sRGB">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0.3" result="blur" />
        <feColorMatrix in="blur" type="matrix" values="1 0 0 0 0  0 1.05 0 0 0  0 0 1 0 0  0 0 0 1 0" result="tint" />
        <feComposite in="tint" in2="SourceGraphic" operator="over" />
      </filter>

      <!-- Displacement map for refraction effect -->
      <filter id="liquid-refract" x="-10%" y="-10%" width="120%" height="120%">
        <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="2" result="noise" seed="5" />
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </defs>
  </svg>

  <!-- Inline loading screen - shows immediately -->
  <div id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">æ­£åœ¨åŠ è½½...</div>
  </div>

  <div id="root" class="h-full w-full"></div>

  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useContext, createContext } = React;
    const { motion, AnimatePresence } = FramerMotion;
    const {
      Home, BookOpen, Trophy, Lightbulb, Plus, Search, MoreHorizontal,
      Clock, Tag, ChevronRight, Mic, Image: ImageIcon, Link: LinkIcon,
      Sparkles, Calendar, CheckCircle2, X, Sun, Moon, Zap, Settings, LogOut
    } = LucideReact;

    // --- æ•°æ®æ¥æ”¶æ¡¥æ¥ ---
    window.receivePapers = (jsonStr) => {
      console.log("receivePapers called with:", typeof jsonStr, Array.isArray(jsonStr) ? `array[${jsonStr.length}]` : (typeof jsonStr === 'string' ? jsonStr.substring(0, 100) : "object"));
      try {
        const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
        console.log("Parsed papers data:", data.length, "items");
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          let authors = "æœªçŸ¥ä½œè€…";
          if (meta.authors && Array.isArray(meta.authors) && meta.authors.length > 0) {
            authors = meta.authors[0] + (meta.authors.length > 1 ? " ç­‰" : "");
          } else if (meta.authors && typeof meta.authors === 'string') {
            authors = meta.authors;
          }

          // è§£ææ¥æºä¿¡æ¯
          let source = "";
          if (meta.source && meta.source.length > 0) {
            source = meta.source;
          }
          if (meta.conference && meta.conference.length > 0) {
            source = source ? `${source} Â· ${meta.conference}` : meta.conference;
          }
          if (meta.year && meta.year.length > 0) {
            source = source ? `${source} ${meta.year}` : meta.year;
          }
          if (!source) {
            source = "æœªçŸ¥æ¥æº";
          }

          // è§£æåŒè¯­æ‘˜è¦
          const summaryEn = meta.summary_en || "";
          const summaryZh = meta.summary_zh || "";
          let displaySummary = item.summary || "æš‚æ— æ‘˜è¦";
          let summaryObj = { en: summaryEn, zh: summaryZh, display: displaySummary };
          // å¦‚æœæœ‰åŒè¯­æ‘˜è¦ï¼Œä¼˜å…ˆä½¿ç”¨ä¸­æ–‡
          if (summaryZh) {
            displaySummary = summaryZh;
          }

          // è§£æ read_statusï¼Œå»æ‰æ‹¬å·å†…çš„ä¸­æ–‡è¯´æ˜
          const rawReadStatus = item.read_status || 'unread';
          const readStatus = rawReadStatus.split(' ')[0].toLowerCase();

          // è§£æ statusï¼Œå»æ‰æ‹¬å·å†…çš„ä¸­æ–‡è¯´æ˜
          const rawStatus = item.status || 'processing';
          const status = rawStatus.split(' ')[0].toLowerCase();

          return {
            id: item.Id || item.id,
            title: item.title,
            author: authors,
            source: source,
            summary: displaySummary,
            summaryEn: summaryEn,
            summaryZh: summaryZh,
            tags: item.tags ? item.tags.split(/[,ï¼Œ]/) : [],
            readStatus: readStatus,   // unread | reading | read
            status: status,           // processing | done | failed
            projectId: item.project_id,
            projectName: item.project_name,
            timestamp: item.UpdatedAt ? new Date(item.UpdatedAt).toLocaleDateString('zh-CN') : "åˆšåˆš"
          };
        });
        console.log("Dispatching papers-updated event with", mapped.length, "items");
        window.dispatchEvent(new CustomEvent('papers-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing papers", e); }
    };

    window.receiveCompetitions = (jsonStr) => {
      console.log("receiveCompetitions called with:", typeof jsonStr, jsonStr ? String(jsonStr).substring(0, 200) : "null");
      try {
        const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
        console.log("Parsed competitions data:", data.length, "items");
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          let daysLeft = 0;
          if (meta.deadline) {
            const diff = new Date(meta.deadline) - new Date();
            daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
          }

          return {
            id: item.Id || item.id,
            title: item.title,
            organizer: meta.organizer || "ä¸»åŠæ–¹æœªçŸ¥",
            deadline: meta.deadline,
            daysLeft: daysLeft,
            status: daysLeft > 0 ? "registered" : "ended",
            tags: item.tags ? item.tags.split(/[,ï¼Œ]/) : []
          };
        });
        console.log("Dispatching competitions-updated event with", mapped.length, "items");
        window.dispatchEvent(new CustomEvent('competitions-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing comps", e); }
    };

    window.receiveProjects = (jsonStr) => {
      console.log("receiveProjects called with:", typeof jsonStr, jsonStr ? String(jsonStr).substring(0, 200) : "null");
      try {
        const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
        console.log("Parsed projects data:", data.length, "items");
        window.dispatchEvent(new CustomEvent('projects-updated', { detail: data }));
      } catch (e) { console.error("Error parsing projects", e); }
    };

    window.receiveInsights = (jsonStr) => {
      console.log("receiveInsights called with:", typeof jsonStr, jsonStr ? String(jsonStr).substring(0, 200) : "null");
      try {
        const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
        console.log("Parsed insights data:", data.length, "items");
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          const rawReadStatus = item.read_status || 'unread';
          const readStatus = rawReadStatus.split(' ')[0].toLowerCase();
          const rawStatus = item.status || 'processing';
          const status = rawStatus.split(' ')[0].toLowerCase();

          return {
            id: item.Id || item.id,
            title: item.title,
            summary: item.summary || "æš‚æ— æè¿°",
            source: meta.source || "ä¸ªäººçµæ„Ÿ",
            category: meta.category || "æœªåˆ†ç±»",
            readStatus: readStatus,
            status: status,
            timestamp: item.UpdatedAt ? new Date(item.UpdatedAt).toLocaleDateString('zh-CN') : "åˆšåˆš",
            itemType: 'insight'
          };
        });
        window.dispatchEvent(new CustomEvent('insights-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing insights", e); }
    };

    window.receiveVoiceItems = (jsonStr) => {
      console.log("receiveVoiceItems called with:", typeof jsonStr, jsonStr ? String(jsonStr).substring(0, 200) : "null");
      try {
        const data = typeof jsonStr === 'string' ? JSON.parse(jsonStr) : jsonStr;
        console.log("Parsed voice items data:", data.length, "items");
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          const rawReadStatus = item.read_status || 'unread';
          const readStatus = rawReadStatus.split(' ')[0].toLowerCase();
          const rawStatus = item.status || 'done';
          const status = rawStatus.split(' ')[0].toLowerCase();

          // æ ¼å¼åŒ–æ—¶é•¿
          const duration = meta.duration || 0;
          const minutes = Math.floor(duration / 60);
          const seconds = duration % 60;
          const durationStr = minutes > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${seconds}ç§’`;

          return {
            id: item.Id || item.id,
            title: item.title || "è¯­éŸ³çµæ„Ÿ",
            summary: meta.transcription || item.summary || "æš‚æ— è½¬å†™å†…å®¹",
            duration: duration,
            durationStr: durationStr,
            audioUrl: item.audio_url,
            readStatus: readStatus,
            status: status,
            timestamp: item.UpdatedAt ? new Date(item.UpdatedAt).toLocaleDateString('zh-CN') : "åˆšåˆš",
            itemType: 'voice'
          };
        });
        window.dispatchEvent(new CustomEvent('voice-items-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing voice items", e); }
    };

    // --- ä¸»é¢˜ä¸Šä¸‹æ–‡é…ç½® ---
    const ThemeContext = createContext({ isDark: true, toggleTheme: () => { } });

    // --- åŸºç¡€ç»„ä»¶ ---
    const GlassCard = ({ children, className = "", delay = 0, noPadding = false, ...props }) => {
      const { isDark } = useContext(ThemeContext);

      return (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: delay, type: "spring", stiffness: 100 }}
          whileTap={{ scale: 0.98 }}
          className={`
                liquid-glass ${isDark ? 'liquid-glass-dark' : ''}
                ${noPadding ? '' : 'p-5'}
                rounded-[2rem]
                group
                transition-all duration-300 ease-out
                ${className}
              `}
          style={{
            background: isDark
              ? 'rgba(255, 255, 255, 0.03)'
              : 'rgba(255, 255, 255, 0.15)',
            backdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
            WebkitBackdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
            border: isDark
              ? '1px solid rgba(255, 255, 255, 0.08)'
              : '1px solid rgba(255, 255, 255, 0.35)',
            boxShadow: isDark
              ? '0 8px 32px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.03)'
              : '0 8px 32px rgba(0, 0, 0, 0.06), inset 0 2px 0 rgba(255, 255, 255, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.2)'
          }}
          {...props}
        >
          <div className="relative z-10">
            {children}
          </div>
        </motion.div>
      );
    };

    const TagBadge = ({ text, color = "blue" }) => {
      const { isDark } = useContext(ThemeContext);

      const getColors = () => {
        switch (color) {
          case "purple":
            return isDark
              ? "bg-teal-500/20 text-teal-200 border-teal-500/30"
              : "bg-teal-100 text-teal-700 border-teal-200";
          case "emerald":
            return isDark
              ? "bg-emerald-500/20 text-emerald-200 border-emerald-500/30"
              : "bg-emerald-100 text-emerald-700 border-emerald-200";
          default: // blue
            return isDark
              ? "bg-cyan-500/20 text-cyan-200 border-cyan-500/30"
              : "bg-cyan-100 text-cyan-700 border-cyan-200";
        }
      };

      return (
        <span className={`px-2.5 py-1 text-[10px] font-semibold rounded-full border transition-colors duration-500 ${getColors()}`}>
          {text}
        </span>
      );
    };

    const SectionHeader = ({ icon: Icon, title, colorClass }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        <div className="flex items-center gap-2 mb-4 px-1 mt-8 first:mt-2">
          <div className={`p-1.5 rounded-lg ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <Icon className={`w-3.5 h-3.5 ${colorClass}`} />
          </div>
          <h2 className={`text-xs font-bold uppercase tracking-widest transition-colors duration-500 ${isDark ? 'text-white/40' : 'text-black/40'}`}>
            {title}
          </h2>
        </div>
      );
    };

    // --- é¡µé¢è§†å›¾ ---

    const HomeView = ({ papers, competitions, insights, voiceItems }) => {
      const { isDark } = useContext(ThemeContext);

      // åˆå¹¶insightså’ŒvoiceItemsï¼Œç»Ÿä¸€æ˜¾ç¤ºåœ¨"æœ€è¿‘åŠ¨æ€"åŒºåŸŸ
      // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
      const allDynamics = [
        ...(insights || []).map(i => ({ ...i, itemType: i.itemType || 'insight' })),
        ...(voiceItems || []).map(v => ({ ...v, itemType: 'voice' }))
      ].sort((a, b) => new Date(b.timestamp || 0) - new Date(a.timestamp || 0));

      // ç«èµ›æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨æœ€å·¦è¾¹
      const sortedCompetitions = [...(competitions || [])]
        .sort((a, b) => new Date(b.CreatedAt || 0) - new Date(a.CreatedAt || 0));

      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });

      return (
        <div className="space-y-2 pb-28">
          {/* Date Header */}
          <div className="flex justify-between items-center px-2 mb-4">
            <div>
              <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                ä»Šæ—¥åŠ¨æ€
              </h1>
              <p className={`text-xs font-medium mt-1 transition-colors duration-500 ${isDark ? 'text-white/40' : 'text-slate-500'}`}>
                {dateStr}
              </p>
            </div>

            <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-500 border ${isDark ? 'bg-white/10 border-white/10' : 'bg-white border-slate-200 shadow-sm'}`}>
              <div className="relative">
                <div className="w-2 h-2 bg-emerald-500 rounded-full absolute top-0 right-0 border-2 border-white dark:border-zinc-900" />
                <ImageIcon className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-slate-600'}`} />
              </div>
            </div>
          </div>

          {/* æœ€è¿‘æ•è· Section - æ˜¾ç¤ºåŠ¨æ€å’Œè¯­éŸ³ */}
          <SectionHeader icon={Lightbulb} title="æœ€è¿‘åŠ¨æ€" colorClass="text-amber-400" />

          {allDynamics.length > 0 ? (
            <div className="space-y-3">
              {allDynamics.map((item, idx) => (
                <GlassCard key={`${item.itemType}-${item.id}`} delay={0.05 * idx} className="group" onClick={() => {
                  if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
                    window.AndroidInterface.navigateToDetail(String(item.id));
                  }
                }}>
                  {/* é¡¶éƒ¨çŠ¶æ€æŒ‡ç¤ºå™¨ */}
                  <div className={`absolute top-0 right-0 p-3 transition-opacity duration-500 ${isDark ? 'opacity-50' : 'opacity-100'}`}>
                    <div className="flex items-center gap-2">
                      <span className={`text-[10px] font-bold tracking-wider uppercase ${item.status === 'done'
                        ? (isDark ? 'text-emerald-400' : 'text-emerald-600')
                        : item.status === 'failed'
                          ? (isDark ? 'text-red-400' : 'text-red-600')
                          : (isDark ? 'text-amber-400' : 'text-amber-600')
                        }`}>
                        {item.itemType === 'voice'
                          ? (item.status === 'done' ? 'å·²è½¬å†™' : 'è½¬å†™ä¸­')
                          : (item.status === 'done' ? 'å·²è§£æ' : item.status === 'failed' ? 'è§£æå¤±è´¥' : 'è§£æä¸­')}
                      </span>
                      <div className={`w-1.5 h-1.5 rounded-full animate-pulse shadow-lg ${item.status === 'done' ? 'bg-emerald-400 shadow-emerald-500/50' :
                        item.status === 'failed' ? 'bg-red-400 shadow-red-500/50' :
                          'bg-amber-400 shadow-amber-500/50'
                        }`} />
                    </div>
                  </div>

                  <div className="flex items-start gap-4 mb-3">
                    {/* æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡ï¼švoiceç”¨éº¦å…‹é£ï¼Œinsightç”¨ç¯æ³¡ */}
                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-lg ${item.itemType === 'voice'
                      ? 'shadow-orange-500/20 bg-gradient-to-br from-orange-500 to-red-500'
                      : 'shadow-amber-500/20 bg-gradient-to-br from-amber-500 to-orange-500'
                      }`}>
                      {item.itemType === 'voice' ? <Mic className="w-6 h-6" /> : <Lightbulb className="w-6 h-6" />}
                    </div>
                    <div className="flex-1 pt-1 pr-16">
                      <h3 className={`text-base font-bold leading-tight mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                        {item.title}
                      </h3>
                      <p className={`text-xs transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                        {item.itemType === 'voice' ? `è¯­éŸ³ Â· ${item.durationStr || ''}` : (item.source || 'çµæ„Ÿ')}
                      </p>
                    </div>
                  </div>

                  {/* å†…å®¹åŒºåŸŸ - voiceæ˜¾ç¤ºè½¬å†™æ–‡æœ¬ï¼Œinsightæ˜¾ç¤ºæ‘˜è¦ */}
                  {item.summary && (
                    <div className={`p-3 rounded-xl border transition-all duration-500 ${item.itemType === 'voice'
                      ? (isDark ? 'bg-orange-900/20 border-orange-500/10' : 'bg-orange-50/50 border-orange-100')
                      : (isDark ? 'bg-emerald-900/20 border-emerald-500/10' : 'bg-emerald-50/50 border-emerald-100')
                      }`}>
                      <div className={`flex items-center gap-2 text-xs font-semibold mb-2 ${item.itemType === 'voice' ? 'text-orange-500' : 'text-emerald-500'
                        }`}>
                        {item.itemType === 'voice' ? <Mic className="w-3 h-3" /> : <Sparkles className="w-3 h-3" />}
                        <span>{item.itemType === 'voice' ? 'è¯­éŸ³è½¬å†™' : 'AI æ ¸å¿ƒæ‘˜è¦'}</span>
                        {/* åŒè¯­åˆ‡æ¢æŒ‰é’® - ä»…insightæœ‰ */}
                        {item.itemType === 'insight' && item.summaryEn && item.summaryZh && (
                          <div className="ml-auto flex gap-1">
                            <span className={`text-[10px] px-1.5 py-0.5 rounded cursor-pointer ${isDark ? 'bg-slate-700 hover:bg-slate-600' : 'bg-slate-200 hover:bg-slate-300'}`}
                              onClick={(e) => {
                                e.stopPropagation();
                                const summaryEl = e.target.closest('.p-3').querySelector('.summary-text');
                                if (summaryEl) summaryEl.textContent = '"' + item.summaryZh + '"';
                              }}>ä¸­</span>
                            <span className={`text-[10px] px-1.5 py-0.5 rounded cursor-pointer ${isDark ? 'bg-slate-700 hover:bg-slate-600' : 'bg-slate-200 hover:bg-slate-300'}`}
                              onClick={(e) => {
                                e.stopPropagation();
                                const summaryEl = e.target.closest('.p-3').querySelector('.summary-text');
                                if (summaryEl) summaryEl.textContent = '"' + item.summaryEn + '"';
                              }}>En</span>
                          </div>
                        )}
                      </div>
                      <p className={`summary-text text-sm leading-relaxed line-clamp-2 transition-colors duration-500 ${item.itemType === 'voice'
                        ? (isDark ? 'text-orange-100/90' : 'text-slate-700')
                        : (isDark ? 'text-emerald-100/90' : 'text-slate-700')
                        }`}>
                        "{item.summary}"
                      </p>
                    </div>
                  )}

                  {/* åº•éƒ¨çŠ¶æ€æ ‡ç­¾ */}
                  <div className="flex items-center justify-between mt-3">
                    <div className="flex gap-2">
                      <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${item.readStatus === 'read'
                        ? (isDark ? 'bg-emerald-500/20 text-emerald-300' : 'bg-emerald-50 text-emerald-600')
                        : item.readStatus === 'reading'
                          ? (isDark ? 'bg-blue-500/20 text-blue-300' : 'bg-blue-50 text-blue-600')
                          : (isDark ? 'bg-amber-500/20 text-amber-300' : 'bg-amber-50 text-amber-600')
                        }`}>
                        {item.readStatus === 'read' ? 'å·²è¯»' : item.readStatus === 'reading' ? 'åœ¨è¯»' : 'æœªè¯»'}
                      </span>
                      <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${item.itemType === 'voice'
                        ? (isDark ? 'bg-orange-500/20 text-orange-300' : 'bg-orange-50 text-orange-600')
                        : (isDark ? 'bg-amber-500/20 text-amber-300' : 'bg-amber-50 text-amber-600')
                        }`}>
                        {item.itemType === 'voice' ? 'è¯­éŸ³' : 'åŠ¨æ€'}
                      </span>
                    </div>
                    <span className={`text-xs ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
                      {item.timestamp}
                    </span>
                  </div>
                </GlassCard>
              ))}
            </div>
          ) : (
            <GlassCard><p className={`text-center opacity-50 ${isDark ? 'text-white' : 'text-slate-500'}`}>æš‚æ— æœ€è¿‘åŠ¨æ€</p></GlassCard>
          )}

          {/* Competitions Section */}
          <SectionHeader icon={Trophy} title="å³å°†æˆªæ­¢" colorClass="text-rose-400" />

          {sortedCompetitions.length > 0 ? (
            <div className="flex gap-4 overflow-x-auto pb-6 -mx-6 px-6 scrollbar-hide">
              {sortedCompetitions.map((comp, idx) => (
                <GlassCard key={comp.id} delay={0.1 * idx} className="min-w-[280px]">
                  <div className="flex justify-between items-start mb-3">
                    <span className={`text-[10px] font-bold px-2 py-1.5 rounded text-xs tracking-wide ${isDark ? 'bg-rose-500/20 text-rose-300 border border-rose-500/30' : 'bg-rose-50 text-rose-600 border border-rose-200'
                      }`}>
                      å‰©ä½™ {comp.daysLeft} å¤©
                    </span>
                    <div className={`w-2 h-2 rounded-full ${comp.status === 'registered' ? 'bg-emerald-400 shadow-[0_0_8px_#34D399]' : 'bg-slate-300'}`} />
                  </div>

                  <h3 className={`text-base font-bold mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {comp.title}
                  </h3>
                  <p className={`text-xs mb-4 transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    {comp.organizer}
                  </p>

                  <div className={`w-full h-1.5 rounded-full overflow-hidden ${isDark ? 'bg-white/10' : 'bg-slate-100'}`}>
                    <div className="bg-gradient-to-r from-rose-500 to-orange-500 h-full w-[70%] rounded-full" />
                  </div>
                </GlassCard>
              ))}
            </div>
          ) : (
            <div className={`text-center py-4 text-xs ${isDark ? 'text-white/30' : 'text-slate-400'}`}>æš‚æ— å³å°†æˆªæ­¢çš„æ¯”èµ›</div>
          )}
        </div>
      );
    };

    const PapersView = ({ papers, projects, onFilterChange, currentFilter }) => {
      const { isDark } = useContext(ThemeContext);
      const [showSearch, setShowSearch] = useState(false);
      const [searchQuery, setSearchQuery] = useState("");
      const [activeFilterIndex, setActiveFilterIndex] = useState(0);
      const [menuOpenId, setMenuOpenId] = useState(null);  // è·Ÿè¸ªå“ªä¸ªå¡ç‰‡çš„èœå•æ‰“å¼€

      const handleSearch = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        if (window.AndroidInterface && window.AndroidInterface.search) {
          window.AndroidInterface.search(query);
        }
      };

      const handleToggleSearch = () => {
        if (showSearch) {
          // æ”¶å›æ—¶å…ˆæ¸…ç©ºæœç´¢
          setSearchQuery("");
          if (window.AndroidInterface && window.AndroidInterface.search) {
            window.AndroidInterface.search("");
          }
        }
        setShowSearch(!showSearch);
      };

      // æ„å»ºç­›é€‰æŒ‰é’®åˆ—è¡¨ï¼šå…¨éƒ¨ã€æœªè¯»ã€æ ‡æ˜Ÿ + åŠ¨æ€é¡¹ç›®åˆ—è¡¨
      const filters = [
        { label: "å…¨éƒ¨", type: "all", projectId: null },
        { label: "æœªè¯»", type: "unread", projectId: null },
        { label: "æ ‡æ˜Ÿ", type: "starred", projectId: null },
        ...projects.map(p => ({ label: p.name, type: "project", projectId: p.id }))
      ];

      const handleFilterClick = (index, filter) => {
        console.log("Filter clicked:", index, filter);
        setActiveFilterIndex(index);
        if (window.AndroidInterface && window.AndroidInterface.applyFilter) {
          console.log("Calling AndroidInterface.applyFilter:", filter.type, filter.projectId);
          window.AndroidInterface.applyFilter(filter.type, filter.projectId ? String(filter.projectId) : null);
        } else {
          console.log("AndroidInterface.applyFilter not available");
        }
        if (onFilterChange) {
          onFilterChange(filter);
        }
      };

      const handleMenuClick = (e, paperId) => {
        e.stopPropagation();
        setMenuOpenId(menuOpenId === paperId ? null : paperId);
      };

      const handleEditClick = (e, paperId) => {
        e.stopPropagation();
        setMenuOpenId(null);
        console.log("Edit clicked, paperId:", paperId);
        if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
          console.log("Calling AndroidInterface.navigateToDetail:", String(paperId));
          window.AndroidInterface.navigateToDetail(String(paperId));
        } else {
          console.log("AndroidInterface.navigateToDetail not available");
        }
      };

      const handleDeleteClick = (e, paperId) => {
        e.stopPropagation();
        setMenuOpenId(null);
        if (window.AndroidInterface && window.AndroidInterface.deleteItem) {
          window.AndroidInterface.deleteItem(String(paperId));
        }
      };

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-2 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>è®ºæ–‡åº“</h1>
            <button
              onClick={handleToggleSearch}
              className={`p-2.5 rounded-full transition-all duration-300 ${showSearch
                ? (isDark ? 'bg-emerald-500/20 text-emerald-400' : 'bg-emerald-50 text-emerald-600')
                : (isDark ? 'bg-white/10 text-white hover:bg-white/20' : 'bg-white text-slate-600 shadow-sm hover:bg-slate-50')
                }`}>
              {showSearch ? <X className="w-5 h-5" /> : <Search className="w-5 h-5" />}
            </button>
          </div>

          {/* æœç´¢æ¡† - æ¶²æ€ç»ç’ƒæ•ˆæœ */}
          {showSearch && (
            <div className="px-1 mb-2">
              <input
                type="text"
                placeholder="æœç´¢è®ºæ–‡æ ‡é¢˜ã€æ‘˜è¦æˆ–æ ‡ç­¾..."
                value={searchQuery}
                onChange={handleSearch}
                autoFocus
                className={`liquid-glass ${isDark ? 'liquid-glass-dark' : ''} w-full p-3 rounded-xl outline-none transition-colors duration-300`}
                style={{
                  background: isDark
                    ? 'rgba(255, 255, 255, 0.03)'
                    : 'rgba(255, 255, 255, 0.12)',
                  backdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                  WebkitBackdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                  border: isDark
                    ? '1px solid rgba(255, 255, 255, 0.08)'
                    : '1px solid rgba(255, 255, 255, 0.3)',
                  color: isDark ? '#fff' : '#1e293b',
                  boxShadow: isDark
                    ? 'inset 0 1px 0 rgba(255, 255, 255, 0.04)'
                    : 'inset 0 1px 0 rgba(255, 255, 255, 0.4)'
                }}
              />
            </div>
          )}

          <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide px-1">
            {filters.map((filter, i) => (
              <button
                key={filter.label + i}
                onClick={() => handleFilterClick(i, filter)}
                className={`${i !== activeFilterIndex ? `liquid-glass ${isDark ? 'liquid-glass-dark' : ''}` : ''} px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all duration-300 flex-shrink-0`}
                style={i === activeFilterIndex ? {
                  background: isDark ? 'rgba(255,255,255,0.85)' : '#1e293b',
                  color: isDark ? '#000' : '#fff',
                  boxShadow: isDark
                    ? '0 4px 12px rgba(255,255,255,0.15)'
                    : '0 4px 12px rgba(0,0,0,0.12)'
                } : {
                  background: isDark
                    ? 'rgba(255, 255, 255, 0.02)'
                    : 'rgba(255, 255, 255, 0.1)',
                  backdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                  WebkitBackdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                  border: isDark
                    ? '1px solid rgba(255, 255, 255, 0.06)'
                    : '1px solid rgba(255, 255, 255, 0.25)',
                  color: isDark ? 'rgba(255,255,255,0.75)' : '#475569',
                  boxShadow: isDark
                    ? 'inset 0 1px 0 rgba(255, 255, 255, 0.03)'
                    : 'inset 0 1px 0 rgba(255, 255, 255, 0.35)'
                }}>
                {filter.label}
              </button>
            ))}
          </div>

          {papers.length === 0 ? (
            <div className={`text-center py-20 ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
              <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³è®ºæ–‡</p>
            </div>
          ) : (
            papers.map((paper, idx) => (
              <GlassCard
                key={paper.id}
                delay={0.05 * idx}
                className="flex flex-col gap-3"
                onClick={() => {
                  console.log("Card clicked, paper.id:", paper.id);
                  if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
                    console.log("Calling AndroidInterface.navigateToDetail:", String(paper.id));
                    window.AndroidInterface.navigateToDetail(String(paper.id));
                  } else {
                    console.log("AndroidInterface.navigateToDetail not available");
                  }
                }}
              >
                {/* é¡¶éƒ¨çŠ¶æ€åŒºåŸŸ */}
                <div className="flex justify-between items-start">
                  <div className="flex gap-2 flex-wrap">
                    {/* é˜…è¯»çŠ¶æ€æ ‡ç­¾ */}
                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${paper.readStatus === 'read'
                      ? (isDark ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30' : 'bg-emerald-50 text-emerald-600 border border-emerald-200')
                      : paper.readStatus === 'reading'
                        ? (isDark ? 'bg-blue-500/20 text-blue-300 border border-blue-500/30' : 'bg-blue-50 text-blue-600 border border-blue-200')
                        : (isDark ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-amber-50 text-amber-600 border border-amber-200')
                      }`}>
                      {paper.readStatus === 'read' ? 'å·²è¯»' : paper.readStatus === 'reading' ? 'åœ¨è¯»' : 'æœªè¯»'}
                    </span>
                    {/* è§£æçŠ¶æ€æ ‡ç­¾ */}
                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${paper.status === 'done'
                      ? (isDark ? 'bg-teal-500/20 text-teal-300 border border-teal-500/30' : 'bg-teal-50 text-teal-600 border border-teal-200')
                      : paper.status === 'failed'
                        ? (isDark ? 'bg-red-500/20 text-red-300 border border-red-500/30' : 'bg-red-50 text-red-600 border border-red-200')
                        : (isDark ? 'bg-purple-500/20 text-purple-300 border border-purple-500/30' : 'bg-purple-50 text-purple-600 border border-purple-200')
                      }`}>
                      {paper.status === 'done' ? 'å·²è§£æ' : paper.status === 'failed' ? 'è§£æå¤±è´¥' : 'è§£æä¸­'}
                    </span>
                    {/* é¡¹ç›®å½’å±æ ‡ç­¾ */}
                    {paper.projectName && (
                      <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${isDark ? 'bg-cyan-500/20 text-cyan-300 border border-cyan-500/30' : 'bg-cyan-50 text-cyan-600 border border-cyan-200'}`}>
                        {paper.projectName}
                      </span>
                    )}
                  </div>
                  {/* ä¸‰ä¸ªç‚¹èœå• */}
                  <div className="relative">
                    <button
                      onClick={(e) => handleMenuClick(e, paper.id)}
                      className={`p-1 rounded-lg transition-colors duration-300 ${isDark ? 'text-white/30 hover:text-white hover:bg-white/10' : 'text-slate-400 hover:text-slate-700 hover:bg-slate-100'}`}
                    >
                      <MoreHorizontal className="w-5 h-5" />
                    </button>
                    {/* ä¸‹æ‹‰èœå• */}
                    {menuOpenId === paper.id && (
                      <div
                        className={`absolute right-0 top-8 z-50 min-w-[120px] rounded-xl overflow-hidden shadow-lg`}
                        style={{
                          background: isDark
                            ? '#1f2937'
                            : '#ffffff',
                          border: isDark
                            ? '1px solid rgba(255, 255, 255, 0.1)'
                            : '1px solid rgba(0, 0, 0, 0.08)',
                          boxShadow: isDark
                            ? '0 8px 24px rgba(0, 0, 0, 0.5)'
                            : '0 8px 24px rgba(0, 0, 0, 0.15)'
                        }}
                      >
                        <button
                          onClick={(e) => handleEditClick(e, paper.id)}
                          className={`w-full px-4 py-2.5 text-sm text-left flex items-center gap-2 ${isDark ? 'text-white hover:bg-white/10' : 'text-slate-700 hover:bg-slate-50'}`}
                        >
                          <span>ğŸ“</span> ç¼–è¾‘
                        </button>
                        <button
                          onClick={(e) => handleDeleteClick(e, paper.id)}
                          className={`w-full px-4 py-2.5 text-sm text-left flex items-center gap-2 ${isDark ? 'text-red-400 hover:bg-red-500/10' : 'text-red-500 hover:bg-red-50'}`}
                        >
                          <span>ğŸ—‘ï¸</span> åˆ é™¤
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                {/* æ ‡é¢˜å’Œä½œè€… */}
                <div className="flex-1">
                  <h3 className={`text-lg font-bold leading-snug mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {paper.title}
                  </h3>
                  <p className={`text-xs transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    {paper.author} Â· {paper.source || 'æ¥æºæœªçŸ¥'}
                  </p>
                </div>

                <p className={`text-sm leading-relaxed line-clamp-2 transition-colors duration-500 ${isDark ? 'text-white/70' : 'text-slate-600'}`}>
                  {paper.summary}
                </p>

                <div className="flex items-center justify-between pt-2 border-t border-dashed border-white/10">
                  <div className="flex gap-2">
                    {paper.tags.map(tag => <TagBadge key={tag} text={tag} color="purple" />)}
                  </div>
                  <div className={`flex items-center gap-1.5 text-xs font-medium ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
                    <Clock className="w-3.5 h-3.5" />
                    {paper.timestamp}
                  </div>
                </div>
              </GlassCard>
            ))
          )}
        </div>
      );
    };

    const CompetitionsView = ({ competitions }) => {
      const { isDark } = useContext(ThemeContext);

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-6 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>ç«èµ›æ´»åŠ¨</h1>
          </div>

          {competitions.length === 0 ? (
            <div className={`text-center py-20 ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
              <p>æš‚æ— ç«èµ›ä¿¡æ¯</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-4">
              {competitions.map((comp, idx) => (
                <GlassCard key={comp.id} delay={0.1 * idx} onClick={() => {
                  if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
                    console.log("Navigating to competition detail:", comp.id);
                    window.AndroidInterface.navigateToDetail(String(comp.id));
                  }
                }}>
                  <div className="flex justify-between items-start mb-3">
                    <span className={`text-[10px] font-bold px-2 py-1.5 rounded text-xs tracking-wide ${isDark ? 'bg-rose-500/20 text-rose-300 border border-rose-500/30' : 'bg-rose-50 text-rose-600 border border-rose-200'
                      }`}>
                      å‰©ä½™ {comp.daysLeft} å¤©
                    </span>
                    <div className={`w-2 h-2 rounded-full ${comp.status === 'registered' ? 'bg-emerald-400 shadow-[0_0_8px_#34D399]' : 'bg-slate-300'}`} />
                  </div>

                  <h3 className={`text-xl font-bold mb-2 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {comp.title}
                  </h3>
                  <p className={`text-sm mb-4 transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    {comp.organizer}
                  </p>

                  <div className="flex gap-2">
                    {comp.tags.map(tag => <TagBadge key={tag} text={tag} color="emerald" />)}
                  </div>
                </GlassCard>
              ))}
            </div>
          )}
        </div>
      );
    };

    const SettingsView = () => {
      const { isDark, toggleTheme } = useContext(ThemeContext);
      const [floatingEnabled, setFloatingEnabled] = useState(false);
      const [hasFloatingPermission, setHasFloatingPermission] = useState(false);

      // æ£€æŸ¥æ‚¬æµ®çª—çŠ¶æ€
      useEffect(() => {
        if (window.AndroidInterface && window.AndroidInterface.checkFloatingWindowStatus) {
          const status = window.AndroidInterface.checkFloatingWindowStatus();
          try {
            const parsed = JSON.parse(status);
            setFloatingEnabled(parsed.enabled);
            setHasFloatingPermission(parsed.hasPermission);
          } catch (e) { }
        }
      }, []);

      const handleFloatingToggle = () => {
        if (!hasFloatingPermission) {
          // æ²¡æœ‰æƒé™ï¼Œè·³è½¬åˆ°ç³»ç»Ÿè®¾ç½®
          if (window.AndroidInterface && window.AndroidInterface.requestFloatingWindowPermission) {
            window.AndroidInterface.requestFloatingWindowPermission();
          }
        } else {
          // åˆ‡æ¢å¼€å…³
          const newState = !floatingEnabled;
          setFloatingEnabled(newState);
          if (window.AndroidInterface && window.AndroidInterface.setFloatingWindowEnabled) {
            window.AndroidInterface.setFloatingWindowEnabled(newState);
          }
        }
      };

      const handleLogout = () => {
        if (window.AndroidInterface && window.AndroidInterface.logout) {
          window.AndroidInterface.logout();
        } else {
          console.log("Logout clicked (AndroidInterface not found)");
        }
      };

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-6 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>è®¾ç½®</h1>
          </div>

          {/* æ‚¬æµ®çª—è®¾ç½® */}
          <GlassCard>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-full bg-gradient-to-br from-cyan-500 to-emerald-500`}>
                  <Zap className="w-5 h-5 text-white" />
                </div>
                <div>
                  <span className={`font-medium block ${isDark ? 'text-white' : 'text-slate-900'}`}>æ‚¬æµ®çª—åŠ©æ‰‹</span>
                  <span className={`text-xs ${hasFloatingPermission ? (isDark ? 'text-emerald-400' : 'text-emerald-600') : (isDark ? 'text-amber-400' : 'text-amber-600')}`}>
                    {hasFloatingPermission ? 'å·²æˆæƒ' : 'ç‚¹å‡»æˆæƒæƒé™'}
                  </span>
                </div>
              </div>
              <button
                onClick={handleFloatingToggle}
                className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${floatingEnabled && hasFloatingPermission ? 'bg-emerald-500' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${floatingEnabled && hasFloatingPermission ? 'translate-x-6' : 'translate-x-0'}`} />
              </button>
            </div>
            {floatingEnabled && hasFloatingPermission && (
              <div className={`mt-3 pt-3 border-t ${isDark ? 'border-white/10' : 'border-slate-200'}`}>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                  é€€å‡ºåº”ç”¨åæ‚¬æµ®çƒå°†è‡ªåŠ¨æ˜¾ç¤ºï¼Œæ”¯æŒæˆªå›¾ã€åŒºåŸŸé€‰æ‹©ã€é“¾æ¥è¯†åˆ«ç­‰åŠŸèƒ½
                </p>
              </div>
            )}
          </GlassCard>

          {/* æ·±è‰²æ¨¡å¼ */}
          <GlassCard>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-full ${isDark ? 'bg-white/10' : 'bg-slate-100'}`}>
                  {isDark ? <Moon className="w-5 h-5 text-white" /> : <Sun className="w-5 h-5 text-amber-500" />}
                </div>
                <span className={`font-medium ${isDark ? 'text-white' : 'text-slate-900'}`}>æ·±è‰²æ¨¡å¼</span>
              </div>
              <button
                onClick={toggleTheme}
                className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${isDark ? 'bg-emerald-500' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${isDark ? 'translate-x-6' : 'translate-x-0'}`} />
              </button>
            </div>
          </GlassCard>

          <GlassCard>
            <button onClick={handleLogout} className="w-full flex items-center gap-3 p-2 text-red-500 font-medium">
              <LogOut className="w-5 h-5" />
              é€€å‡ºç™»å½•
            </button>
          </GlassCard>
        </div>
      );
    };

    // --- å…¨å±€æ‚¬æµ®ç»„ä»¶ (FAB & Nav) ---

    const CaptureModal = ({ isOpen, onClose }) => {
      const { isDark } = useContext(ThemeContext);

      if (!isOpen) return null;
      return (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-50 flex items-end justify-center p-4"
          onClick={onClose}
        >
          {/* Backdrop */}
          <div className="absolute inset-0 bg-black/5 backdrop-blur-[2px] transition-opacity" />

          <motion.div
            initial={{ y: "110%" }}
            animate={{ y: 0 }}
            exit={{ y: "110%" }}
            transition={{ type: "spring", damping: 30, stiffness: 400 }}
            className={`liquid-glass ${isDark ? 'liquid-glass-dark' : ''} w-full max-w-md relative z-10 rounded-[2.5rem] p-6 pb-8`}
            style={{
              background: isDark
                ? 'rgba(255, 255, 255, 0.03)'
                : 'rgba(255, 255, 255, 0.15)',
              backdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
              WebkitBackdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
              border: isDark
                ? '1px solid rgba(255, 255, 255, 0.08)'
                : '1px solid rgba(255, 255, 255, 0.35)',
              boxShadow: isDark
                ? '0 8px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.06)'
                : '0 8px 40px rgba(0, 0, 0, 0.08), inset 0 2px 0 rgba(255, 255, 255, 0.5)'
            }}
            onClick={e => e.stopPropagation()}
          >
            <div className={`w-12 h-1.5 rounded-full mx-auto mb-8 ${isDark ? 'bg-white/15' : 'bg-slate-400/40'}`} />

            <h3 className={`text-xl font-bold mb-8 text-center transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
              å¿«é€Ÿé‡‡é›†
            </h3>

            <div className="grid grid-cols-3 gap-6">
              {[
                { icon: LinkIcon, label: "é“¾æ¥", color: "from-cyan-400 to-cyan-600", action: "link" },
                { icon: ImageIcon, label: "æ‰«æ", color: "from-emerald-500 to-teal-500", action: "scan" },
                { icon: Mic, label: "è¯­éŸ³", color: "from-orange-500 to-red-500", action: "voice" },
              ].map((item, idx) => (
                <button
                  key={idx}
                  className="flex flex-col items-center gap-4 group"
                  onClick={() => {
                    if (item.action === 'voice' && window.AndroidInterface && window.AndroidInterface.startVoiceRecording) {
                      window.AndroidInterface.startVoiceRecording();
                      setShowQuickCapture(false);
                    } else if (item.action === 'link') {
                      // TODO: é“¾æ¥é‡‡é›†
                    } else if (item.action === 'scan') {
                      // TODO: æ‰«æé‡‡é›†
                    }
                  }}
                >
                  <div className={`
                         w-18 h-18 w-full aspect-square rounded-[1.5rem] flex items-center justify-center text-white shadow-xl 
                         bg-gradient-to-br ${item.color}
                         group-active:scale-95 transition-all duration-200 ring-4 ring-transparent group-hover:ring-white/10
                       `}>
                    <item.icon className="w-8 h-8" />
                  </div>
                  <span className={`text-sm font-medium transition-colors ${isDark ? 'text-white/60' : 'text-slate-500'}`}>
                    {item.label}
                  </span>
                </button>
              ))}
            </div>

            {/* Smart Paste Hint */}
            <div
              className={`liquid-glass ${isDark ? 'liquid-glass-dark' : ''} mt-10 p-4 rounded-2xl flex items-center gap-3`}
              style={{
                background: isDark
                  ? 'rgba(255, 255, 255, 0.02)'
                  : 'rgba(255, 255, 255, 0.1)',
                backdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                WebkitBackdropFilter: `blur(30px) saturate(160%) contrast(1.05) brightness(${isDark ? '1.03' : '1.01'})`,
                border: isDark
                  ? '1px solid rgba(255, 255, 255, 0.05)'
                  : '1px solid rgba(255, 255, 255, 0.25)',
                boxShadow: isDark
                  ? 'inset 0 1px 0 rgba(255, 255, 255, 0.03)'
                  : 'inset 0 1px 0 rgba(255, 255, 255, 0.35)'
              }}
            >
              <div className="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center">
                <Zap className="w-4 h-4 text-emerald-500" fill="currentColor" />
              </div>
              <div className="flex-1">
                <p className={`text-xs font-semibold ${isDark ? 'text-white' : 'text-slate-900'}`}>æ£€æµ‹åˆ°å‰ªè´´æ¿å†…å®¹</p>
                <p className={`text-[10px] ${isDark ? 'text-white/50' : 'text-slate-500'}`}>"https://arxiv.org/abs/2106.09685"</p>
              </div>
              <button className="text-xs font-bold text-blue-500 bg-blue-500/10 px-3 py-1.5 rounded-lg">æ·»åŠ </button>
            </div>
          </motion.div>
        </motion.div>
      );
    };

    const NavBar = ({ activeTab, setActiveTab, onCapture }) => {
      const { isDark } = useContext(ThemeContext);

      const NavButton = ({ id, icon: Icon, label }) => {
        const isActive = activeTab === id;
        return (
          <button
            onClick={() => setActiveTab(id)}
            className="flex flex-col items-center justify-center gap-1 w-14 h-full relative"
          >
            <div className={`transition-all duration-500 ease-out transform ${isActive
              ? (isDark ? 'text-white translate-y-0 scale-110' : 'text-slate-900 translate-y-0 scale-110')
              : (isDark ? 'text-white/30 hover:text-white/50 translate-y-1' : 'text-slate-400 hover:text-slate-600 translate-y-1')
              }`}>
              <Icon className="w-6 h-6" strokeWidth={isActive ? 2.5 : 2} />
            </div>
            <span className={`text-[10px] transition-colors duration-300 ${isActive ? (isDark ? 'text-white' : 'text-slate-900') : 'text-transparent'}`}>{label}</span>
          </button>
        );
      };

      return (
        <div className="fixed bottom-0 w-full max-w-md px-6 pb-6 pt-16 z-40 pointer-events-none">
          {/* Gradient Fade Mask */}
          <div className={`absolute inset-x-0 bottom-0 h-40 bg-gradient-to-t transition-colors duration-500 pointer-events-none ${isDark ? 'from-black via-black/90 to-transparent' : 'from-[#F2F2F7] via-[#F2F2F7]/90 to-transparent'
            }`} />

          <div
            className={`liquid-glass ${isDark ? 'liquid-glass-dark' : ''} relative h-20 rounded-[2.5rem] flex items-center justify-between px-2 pointer-events-auto transition-all duration-300`}
            style={{
              background: isDark
                ? 'rgba(255, 255, 255, 0.03)'
                : 'rgba(255, 255, 255, 0.12)',
              backdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
              WebkitBackdropFilter: `blur(40px) saturate(180%) contrast(1.1) brightness(${isDark ? '1.05' : '1.02'})`,
              border: isDark
                ? '1px solid rgba(255, 255, 255, 0.06)'
                : '1px solid rgba(255, 255, 255, 0.3)',
              boxShadow: isDark
                ? '0 8px 32px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.04)'
                : '0 8px 32px rgba(0, 0, 0, 0.04), inset 0 2px 0 rgba(255, 255, 255, 0.4)'
            }}
          >
            <div className="flex flex-1 justify-around">
              <NavButton id="home" icon={Home} label="é¦–é¡µ" />
              <NavButton id="papers" icon={BookOpen} label="è®ºæ–‡" />
            </div>

            {/* Central FAB */}
            <div className="relative -top-5 mx-2">
              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={onCapture}
                className={`
                      w-18 h-18 rounded-full flex items-center justify-center text-white shadow-lg relative z-50 group
                      bg-gradient-to-tr from-emerald-400 via-teal-500 to-cyan-500
                      border-[6px] transition-colors duration-500
                      ${isDark ? 'border-[#09090b] shadow-emerald-500/20' : 'border-[#F2F2F7] shadow-lg'}
                    `}
              >
                <Plus className="w-8 h-8 group-hover:rotate-90 transition-transform duration-300" />
              </motion.button>

              {/* Breathing Glow */}
              <div className="absolute inset-0 bg-emerald-500 rounded-full blur-xl opacity-40 animate-pulse -z-10 top-2" />
            </div>

            <div className="flex flex-1 justify-around">
              <NavButton id="competitions" icon={Trophy} label="ç«èµ›" />
              <NavButton id="settings" icon={Settings} label="è®¾ç½®" />
            </div>
          </div>
        </div>
      );
    };

    // --- App Entrance ---

    const App = () => {
      const [activeTab, setActiveTab] = useState('home');
      const [isCaptureOpen, setIsCaptureOpen] = useState(false);
      const [isDark, setIsDark] = useState(false); // Default to Light Mode per requirement
      const [papers, setPapers] = useState([]);
      const [competitions, setCompetitions] = useState([]);
      const [projects, setProjects] = useState([]);
      const [insights, setInsights] = useState([]);
      const [voiceItems, setVoiceItems] = useState([]);
      const [currentFilter, setCurrentFilter] = useState({ type: 'all', projectId: null });

      const toggleTheme = () => setIsDark(!isDark);

      // Data Listeners
      useEffect(() => {
        const handlePapers = (e) => {
          console.log("React: papers-updated event received, setting state with", e.detail.length, "items");
          setPapers(e.detail);
        };
        const handleCompetitions = (e) => {
          console.log("React: competitions-updated event received, setting state with", e.detail.length, "items");
          setCompetitions(e.detail);
        };
        const handleProjects = (e) => {
          console.log("React: projects-updated event received, setting state with", e.detail.length, "items");
          setProjects(e.detail);
        };
        const handleInsights = (e) => {
          console.log("React: insights-updated event received, setting state with", e.detail.length, "items");
          setInsights(e.detail);
        };
        const handleVoiceItems = (e) => {
          console.log("React: voice-items-updated event received, setting state with", e.detail.length, "items");
          setVoiceItems(e.detail);
        };

        window.addEventListener('papers-updated', handlePapers);
        window.addEventListener('competitions-updated', handleCompetitions);
        window.addEventListener('projects-updated', handleProjects);
        window.addEventListener('insights-updated', handleInsights);
        window.addEventListener('voice-items-updated', handleVoiceItems);

        // Request initial data
        console.log("React: App mounted, requesting initial data");
        if (window.AndroidInterface && window.AndroidInterface.requestData) {
          window.AndroidInterface.requestData();
        }

        // è·å–é¡¹ç›®åˆ—è¡¨
        if (window.AndroidInterface && window.AndroidInterface.getProjects) {
          try {
            const projectsJson = window.AndroidInterface.getProjects();
            const projectsData = JSON.parse(projectsJson);
            console.log("React: Got projects from Android:", projectsData.length);
            setProjects(projectsData);
          } catch (e) {
            console.error("Error getting projects:", e);
          }
        }

        return () => {
          window.removeEventListener('papers-updated', handlePapers);
          window.removeEventListener('competitions-updated', handleCompetitions);
          window.removeEventListener('projects-updated', handleProjects);
          window.removeEventListener('insights-updated', handleInsights);
          window.removeEventListener('voice-items-updated', handleVoiceItems);
        };
      }, []);

      // æš´éœ² setActiveTab åˆ°å…¨å±€ï¼Œä¾› Android è°ƒç”¨
      useEffect(() => {
        window.setActiveTab = (tab) => {
          console.log('React: setActiveTab called from Android:', tab);
          setActiveTab(tab);
        };
        return () => {
          delete window.setActiveTab;
        };
      }, [setActiveTab]);

      // Status Bar - å¢åŠ é¡¶éƒ¨å®‰å…¨åŒºåŸŸï¼Œä¸ºç³»ç»ŸçŠ¶æ€æ ç•™å‡ºç©ºé—´
      const StatusBar = () => (
        <div className={`flex justify-between items-center px-6 pt-10 pb-2 text-xs font-medium sticky top-0 z-50 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
          <span></span>
          <div className="flex gap-1.5 items-center">
          </div>
        </div>
      );

      return (
        <ThemeContext.Provider value={{ isDark, toggleTheme }}>
          <div className={`h-full flex flex-col overflow-hidden font-sans transition-colors duration-700 ease-in-out ${isDark ? 'bg-[#09090b]' : 'bg-[#F2F2F7]'}`}>

            {/* åŠ¨æ€èƒŒæ™¯å±‚ (Dynamic Ambient Background) */}
            <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
              {/* Tech Grid Overlay */}
              <div className={`absolute inset-0 z-0 transition-opacity duration-1000 ${isDark ? 'opacity-[0.15]' : 'opacity-[0.03]'}`}
                style={{
                  backgroundImage: `linear-gradient(${isDark ? '#10B981' : '#000'} 1px, transparent 1px), linear-gradient(90deg, ${isDark ? '#10B981' : '#000'} 1px, transparent 1px)`,
                  backgroundSize: '40px 40px',
                  transform: 'perspective(500px) rotateX(60deg) translateY(-100px) scale(2)'
                }}
              >
                <div className="absolute inset-0 animate-grid" />
              </div>

              {/* Noise Texture */}
              <div className="absolute inset-0 opacity-[0.05] bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay" />

              {/* Dark Mode Aurora */}
              <motion.div
                animate={{ opacity: isDark ? 1 : 0 }}
                transition={{ duration: 0.8 }}
                className="absolute inset-0"
              >
                <div className="absolute top-[-20%] left-[-20%] w-[600px] h-[600px] bg-emerald-500/20 rounded-full blur-[120px] mix-blend-screen" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-teal-500/20 rounded-full blur-[100px] mix-blend-screen" />
              </motion.div>

              {/* Light Mode Holographic Gradients */}
              <motion.div
                animate={{ opacity: isDark ? 0 : 1 }}
                transition={{ duration: 0.8 }}
                className="absolute inset-0"
              >
                <div className="absolute top-[-20%] left-[-10%] w-[600px] h-[600px] bg-emerald-100/60 rounded-full blur-[100px] mix-blend-multiply" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-cyan-100/60 rounded-full blur-[120px] mix-blend-multiply" />
              </motion.div>
            </div>

            <div className="w-full h-full relative z-10 flex flex-col">
              <StatusBar />

              <main className="flex-1 overflow-y-auto px-6 pt-2 scrollbar-hide pb-28">
                <AnimatePresence mode="wait">
                  {activeTab === 'home' && (
                    <motion.div
                      key="home"
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      exit={{ opacity: 0, scale: 1.05 }}
                      transition={{ duration: 0.3 }}
                    >
                      <HomeView papers={papers} competitions={competitions} insights={insights} voiceItems={voiceItems} />
                    </motion.div>
                  )}
                  {activeTab === 'papers' && (
                    <motion.div
                      key="papers"
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: -20 }}
                      transition={{ duration: 0.3 }}
                    >
                      <PapersView
                        papers={papers}
                        projects={projects}
                        currentFilter={currentFilter}
                        onFilterChange={setCurrentFilter}
                      />
                    </motion.div>
                  )}
                  {activeTab === 'settings' && (
                    <motion.div
                      key="settings"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <SettingsView />
                    </motion.div>
                  )}
                  {activeTab === 'competitions' && (
                    <motion.div
                      key="competitions"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <CompetitionsView competitions={competitions} />
                    </motion.div>
                  )}
                </AnimatePresence>
              </main>

              <NavBar
                activeTab={activeTab}
                setActiveTab={setActiveTab}
                onCapture={() => setIsCaptureOpen(true)}
              />

              <AnimatePresence>
                {isCaptureOpen && <CaptureModal isOpen={isCaptureOpen} onClose={() => setIsCaptureOpen(false)} />}
              </AnimatePresence>

            </div>
          </div>
        </ThemeContext.Provider>
      );
    };

    const root = window.ReactDOM.createRoot(document.getElementById('root'));

    // Wait for deps if needed, but module script runs before this usually?
    // Actually module script is defer by default. text/babel is also defer.
    // We can check if React is ready.

    const render = () => {
      if (window.React && window.ReactDOM && window.FramerMotion && window.LucideReact) {
        root.render(<App />);
        // Smooth transition: hide loader, show content
        requestAnimationFrame(() => {
          document.getElementById('root').classList.add('loaded');
          document.getElementById('loading-screen').classList.add('hidden');
        });
      } else {
        setTimeout(render, 50);
      }
    };

    render();

  </script>
</body>

</html>
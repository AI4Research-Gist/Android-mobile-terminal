<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AI4Research</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <style>
    /* Global Font Settings */
    body {
      font-family: 'Inter', sans-serif;
    }

    h1,
    h2,
    h3,
    h4,
    .font-display {
      font-family: 'Space Grotesk', sans-serif;
    }

    /* Critical: Hide content until fully loaded */
    #root {
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
    }

    #root.loaded {
      opacity: 1;
    }

    /* Inline loading screen - no external dependencies */
    #loading-screen {
      position: fixed;
      inset: 0;
      background: #F2F2F7;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out;
    }

    #loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(16, 185, 129, 0.2);
      border-top-color: #10B981;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      margin-top: 16px;
      font-size: 14px;
      color: #64748b;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes grid-move {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(40px);
      }
    }

    .animate-grid {
      animation: grid-move 20s linear infinite;
    }

    body {
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
      user-select: none;
      margin: 0;
      padding: 0;
    }

    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }

    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
  <!-- Import dependencies as modules and expose to window for Babel script -->
  <script type="module">
    import React from 'https://esm.sh/react@18.2.0';
    import * as ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
    import * as FramerMotion from 'https://esm.sh/framer-motion@10.16.4?deps=react@18.2.0';
    import * as LucideReact from 'https://esm.sh/lucide-react@0.292.0?deps=react@18.2.0';

    window.React = React;
    window.ReactDOM = ReactDOM;
    window.FramerMotion = FramerMotion;
    window.LucideReact = LucideReact;

    // Signal that dependencies are loaded
    window.dispatchEvent(new Event('deps-loaded'));
  </script>
</head>

<body class="bg-[#F2F2F7] text-white h-screen w-screen overflow-hidden">
  <!-- Inline loading screen - shows immediately -->
  <div id="loading-screen">
    <div class="loading-spinner"></div>
    <div class="loading-text">正在加载...</div>
  </div>

  <div id="root" class="h-full w-full"></div>

  <script type="text/babel" data-presets="react,env">
    const { useState, useEffect, useContext, createContext } = React;
    const { motion, AnimatePresence } = FramerMotion;
    const {
      Home, BookOpen, Trophy, Lightbulb, Plus, Search, MoreHorizontal,
      Clock, Tag, ChevronRight, Mic, Image: ImageIcon, Link: LinkIcon,
      Sparkles, Calendar, CheckCircle2, X, Sun, Moon, Zap, Settings, LogOut
    } = LucideReact;

    // --- 数据接收桥接 ---
    window.receivePapers = (jsonStr) => {
      try {
        const data = JSON.parse(jsonStr);
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          let authors = "未知作者";
          if (meta.authors && Array.isArray(meta.authors) && meta.authors.length > 0) {
            authors = meta.authors[0] + (meta.authors.length > 1 ? " 等" : "");
          } else if (meta.authors) {
            authors = meta.authors;
          }

          return {
            id: item.Id || item.id,
            title: item.title,
            author: authors,
            source: (meta.conference || "") + (meta.year ? " " + meta.year : ""),
            summary: item.summary || "暂无摘要",
            tags: item.tags ? item.tags.split(/[,，]/) : [],
            status: item.read_status || 'unread',
            timestamp: item.UpdatedAt ? new Date(item.UpdatedAt).toLocaleDateString('zh-CN') : "刚刚"
          };
        });
        window.dispatchEvent(new CustomEvent('papers-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing papers", e); }
    };

    window.receiveCompetitions = (jsonStr) => {
      try {
        const data = JSON.parse(jsonStr);
        const mapped = data.map(item => {
          let meta = {};
          try {
            if (typeof item.meta_json === 'string') {
              meta = JSON.parse(item.meta_json || '{}');
            } else if (item.meta_json && typeof item.meta_json === 'object') {
              meta = item.meta_json;
            }
          } catch (e) { }

          let daysLeft = 0;
          if (meta.deadline) {
            const diff = new Date(meta.deadline) - new Date();
            daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
          }

          return {
            id: item.Id || item.id,
            title: item.title,
            organizer: meta.organizer || "主办方未知",
            deadline: meta.deadline,
            daysLeft: daysLeft,
            status: daysLeft > 0 ? "registered" : "ended",
            tags: item.tags ? item.tags.split(/[,，]/) : []
          };
        });
        window.dispatchEvent(new CustomEvent('competitions-updated', { detail: mapped }));
      } catch (e) { console.error("Error parsing comps", e); }
    };

    // --- 主题上下文配置 ---
    const ThemeContext = createContext({ isDark: true, toggleTheme: () => { } });

    // --- 基础组件 ---
    const GlassCard = ({ children, className = "", delay = 0, noPadding = false, ...props }) => {
      const { isDark } = useContext(ThemeContext);

      return (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5, delay: delay, type: "spring", stiffness: 100 }}
          whileTap={{ scale: 0.98 }}
          className={`
                relative overflow-hidden transition-all duration-500 ease-in-out
                ${noPadding ? '' : 'p-5'}
                rounded-[2rem]
                ${isDark
              ? 'bg-[#0c0c0e]/60 border-emerald-500/30 shadow-[0_8px_32px_rgba(16,185,129,0.1)]'
              : 'bg-white/70 border-white/60 shadow-[0_8px_32px_rgba(16,185,129,0.05)]'
            }
                backdrop-blur-xl border
                group hover:border-emerald-500/50 hover:shadow-emerald-500/20
                ${className}
              `}
          {...props}
        >
          <div className={`absolute inset-0 bg-gradient-to-br transition-opacity duration-500 pointer-events-none
                ${isDark ? 'from-white/5 to-transparent opacity-100' : 'from-white/40 to-transparent opacity-50'}
              `} />

          <div className="relative z-10">
            {children}
          </div>
        </motion.div>
      );
    };

    const TagBadge = ({ text, color = "blue" }) => {
      const { isDark } = useContext(ThemeContext);

      const getColors = () => {
        switch (color) {
          case "purple":
            return isDark
              ? "bg-teal-500/20 text-teal-200 border-teal-500/30"
              : "bg-teal-100 text-teal-700 border-teal-200";
          case "emerald":
            return isDark
              ? "bg-emerald-500/20 text-emerald-200 border-emerald-500/30"
              : "bg-emerald-100 text-emerald-700 border-emerald-200";
          default: // blue
            return isDark
              ? "bg-cyan-500/20 text-cyan-200 border-cyan-500/30"
              : "bg-cyan-100 text-cyan-700 border-cyan-200";
        }
      };

      return (
        <span className={`px-2.5 py-1 text-[10px] font-semibold rounded-full border transition-colors duration-500 ${getColors()}`}>
          {text}
        </span>
      );
    };

    const SectionHeader = ({ icon: Icon, title, colorClass }) => {
      const { isDark } = useContext(ThemeContext);
      return (
        <div className="flex items-center gap-2 mb-4 px-1 mt-8 first:mt-2">
          <div className={`p-1.5 rounded-lg ${isDark ? 'bg-white/5' : 'bg-black/5'}`}>
            <Icon className={`w-3.5 h-3.5 ${colorClass}`} />
          </div>
          <h2 className={`text-xs font-bold uppercase tracking-widest transition-colors duration-500 ${isDark ? 'text-white/40' : 'text-black/40'}`}>
            {title}
          </h2>
        </div>
      );
    };

    // --- 页面视图 ---

    const HomeView = ({ papers, competitions }) => {
      const { isDark } = useContext(ThemeContext);

      // Use the first paper as "Recently Captured" if available
      const recentPaper = papers.length > 0 ? papers[0] : null;

      const today = new Date();
      const dateStr = today.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' });

      return (
        <div className="space-y-2 pb-28">
          {/* Date Header */}
          <div className="flex justify-between items-center px-2 mb-6">
            <div>
              <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                今日动态
              </h1>
              <p className={`text-xs font-medium mt-1 transition-colors duration-500 ${isDark ? 'text-white/40' : 'text-slate-500'}`}>
                {dateStr}
              </p>
            </div>

            <div className={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-500 border ${isDark ? 'bg-white/10 border-white/10' : 'bg-white border-slate-200 shadow-sm'}`}>
              <div className="relative">
                <div className="w-2 h-2 bg-emerald-500 rounded-full absolute top-0 right-0 border-2 border-white dark:border-zinc-900" />
                <ImageIcon className={`w-5 h-5 ${isDark ? 'text-white/70' : 'text-slate-600'}`} />
              </div>
            </div>
          </div>

          {/* Priority Section */}
          <SectionHeader icon={Sparkles} title="最近捕获" colorClass="text-amber-400" />

          {recentPaper ? (
            <GlassCard className="group" onClick={() => {
              if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
                window.AndroidInterface.navigateToDetail(String(recentPaper.id));
              }
            }}>
              <div className={`absolute top-0 right-0 p-4 transition-opacity duration-500 ${isDark ? 'opacity-50' : 'opacity-100'}`}>
                <div className="flex items-center gap-2">
                  <span className={`text-[10px] font-bold tracking-wider uppercase ${isDark ? 'text-emerald-400' : 'text-emerald-600'}`}>已解析完成</span>
                  <div className="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_10px_#34D399]" />
                </div>
              </div>

              <div className="flex items-start gap-4 mb-4">
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-emerald-500/20 bg-gradient-to-br from-emerald-600 to-teal-600`}>
                  <BookOpen className="w-6 h-6" />
                </div>
                <div className="flex-1 pt-1">
                  <h3 className={`text-lg font-bold leading-tight mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {recentPaper.title}
                  </h3>
                  <p className={`text-sm transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    来源: 微信/Web
                  </p>
                </div>
              </div>

              {/* AI Summary Block */}
              <div className={`p-4 rounded-xl border transition-all duration-500 ${isDark
                ? 'bg-emerald-900/20 border-emerald-500/10'
                : 'bg-emerald-50/50 border-emerald-100'
                }`}>
                <div className="flex items-center gap-2 text-xs font-semibold text-emerald-500 mb-2">
                  <Sparkles className="w-3 h-3" />
                  <span>AI 核心摘要</span>
                </div>
                <p className={`text-sm leading-relaxed transition-colors duration-500 ${isDark ? 'text-emerald-100/90' : 'text-slate-700'}`}>
                  "{recentPaper.summary}"
                </p>
              </div>

              <div className="flex gap-2 mt-4">
                {recentPaper.tags.map(tag => <TagBadge key={tag} text={tag} color="blue" />)}
              </div>
            </GlassCard>
          ) : (
            <GlassCard><p className={`text-center opacity-50 ${isDark ? 'text-white' : 'text-slate-500'}`}>暂无最近捕获内容</p></GlassCard>
          )}

          {/* Competitions Section */}
          <SectionHeader icon={Trophy} title="即将截止" colorClass="text-rose-400" />

          {competitions.length > 0 ? (
            <div className="flex gap-4 overflow-x-auto pb-6 -mx-6 px-6 scrollbar-hide">
              {competitions.map((comp, idx) => (
                <GlassCard key={comp.id} delay={0.1 * idx} className="min-w-[280px]">
                  <div className="flex justify-between items-start mb-3">
                    <span className={`text-[10px] font-bold px-2 py-1.5 rounded text-xs tracking-wide ${isDark ? 'bg-rose-500/20 text-rose-300 border border-rose-500/30' : 'bg-rose-50 text-rose-600 border border-rose-200'
                      }`}>
                      剩余 {comp.daysLeft} 天
                    </span>
                    <div className={`w-2 h-2 rounded-full ${comp.status === 'registered' ? 'bg-emerald-400 shadow-[0_0_8px_#34D399]' : 'bg-slate-300'}`} />
                  </div>

                  <h3 className={`text-base font-bold mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {comp.title}
                  </h3>
                  <p className={`text-xs mb-4 transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    {comp.organizer}
                  </p>

                  <div className={`w-full h-1.5 rounded-full overflow-hidden ${isDark ? 'bg-white/10' : 'bg-slate-100'}`}>
                    <div className="bg-gradient-to-r from-rose-500 to-orange-500 h-full w-[70%] rounded-full" />
                  </div>
                </GlassCard>
              ))}
            </div>
          ) : (
            <div className={`text-center py-4 text-xs ${isDark ? 'text-white/30' : 'text-slate-400'}`}>暂无即将截止的比赛</div>
          )}
        </div>
      );
    };

    const PapersView = ({ papers }) => {
      const { isDark } = useContext(ThemeContext);
      const [showSearch, setShowSearch] = useState(false);
      const [searchQuery, setSearchQuery] = useState("");

      const handleSearch = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        if (window.AndroidInterface && window.AndroidInterface.search) {
          window.AndroidInterface.search(query);
        }
      };

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-2 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>论文库</h1>
            <button
              onClick={() => setShowSearch(!showSearch)}
              className={`p-2.5 rounded-full transition-colors duration-500 ${isDark ? 'bg-white/10 text-white hover:bg-white/20' : 'bg-white text-slate-600 shadow-sm hover:bg-slate-50'}`}>
              <Search className="w-5 h-5" />
            </button>
          </div>

          <AnimatePresence>
            {showSearch && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: "auto", opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
                className="overflow-hidden px-1 mb-2"
              >
                <input
                  type="text"
                  placeholder="搜索论文标题、摘要或标签..."
                  value={searchQuery}
                  onChange={handleSearch}
                  className={`w-full p-3 rounded-xl outline-none border ${isDark ? 'bg-white/5 border-white/10 text-white placeholder-white/30' : 'bg-white border-slate-200 text-slate-900 placeholder-slate-400'}`}
                />
              </motion.div>
            )}
          </AnimatePresence>

          <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide px-1">
            {["全部", "未读", "标星", "Project A", "Project B"].map((filter, i) => (
              <button key={filter} className={`
                    px-5 py-2 rounded-full text-sm font-medium whitespace-nowrap backdrop-blur-md transition-all duration-300
                    ${i === 0
                  ? (isDark ? 'bg-white text-black' : 'bg-slate-900 text-white')
                  : (isDark ? 'bg-white/5 text-white/70 border border-white/10' : 'bg-white/60 text-slate-600 border border-slate-200/50')
                }
                  `}>
                {filter}
              </button>
            ))}
          </div>

          {papers.length === 0 ? (
            <div className={`text-center py-20 ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
              <p>没有找到相关论文</p>
            </div>
          ) : (
            papers.map((paper, idx) => (
              <GlassCard
                key={paper.id}
                delay={0.05 * idx}
                className="flex flex-col gap-3"
                onClick={() => {
                  if (window.AndroidInterface && window.AndroidInterface.navigateToDetail) {
                    window.AndroidInterface.navigateToDetail(String(paper.id));
                  }
                }}
              >
                <div className="flex justify-between items-start">
                  <div className="flex-1 pr-4">
                    <h3 className={`text-lg font-bold leading-snug mb-1 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                      {paper.title}
                    </h3>
                    <p className={`text-xs transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                      {paper.author} · {paper.source}
                    </p>
                  </div>
                  <button className={`transition-colors duration-500 ${isDark ? 'text-white/30 hover:text-white' : 'text-slate-400 hover:text-slate-700'}`}>
                    <MoreHorizontal className="w-5 h-5" />
                  </button>
                </div>

                <p className={`text-sm leading-relaxed line-clamp-2 transition-colors duration-500 ${isDark ? 'text-white/70' : 'text-slate-600'}`}>
                  {paper.summary}
                </p>

                <div className="flex items-center justify-between pt-2 border-t border-dashed border-white/10">
                  <div className="flex gap-2">
                    {paper.tags.map(tag => <TagBadge key={tag} text={tag} color="purple" />)}
                  </div>
                  <div className={`flex items-center gap-1.5 text-xs font-medium ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
                    <Clock className="w-3.5 h-3.5" />
                    {paper.timestamp}
                  </div>
                </div>
              </GlassCard>
            ))
          )}
        </div>
      );
    };

    const CompetitionsView = ({ competitions }) => {
      const { isDark } = useContext(ThemeContext);

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-6 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>竞赛活动</h1>
          </div>

          {competitions.length === 0 ? (
            <div className={`text-center py-20 ${isDark ? 'text-white/30' : 'text-slate-400'}`}>
              <p>暂无竞赛信息</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-4">
              {competitions.map((comp, idx) => (
                <GlassCard key={comp.id} delay={0.1 * idx}>
                  <div className="flex justify-between items-start mb-3">
                    <span className={`text-[10px] font-bold px-2 py-1.5 rounded text-xs tracking-wide ${isDark ? 'bg-rose-500/20 text-rose-300 border border-rose-500/30' : 'bg-rose-50 text-rose-600 border border-rose-200'
                      }`}>
                      剩余 {comp.daysLeft} 天
                    </span>
                    <div className={`w-2 h-2 rounded-full ${comp.status === 'registered' ? 'bg-emerald-400 shadow-[0_0_8px_#34D399]' : 'bg-slate-300'}`} />
                  </div>

                  <h3 className={`text-xl font-bold mb-2 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                    {comp.title}
                  </h3>
                  <p className={`text-sm mb-4 transition-colors duration-500 ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                    {comp.organizer}
                  </p>

                  <div className="flex gap-2">
                    {comp.tags.map(tag => <TagBadge key={tag} text={tag} color="emerald" />)}
                  </div>
                </GlassCard>
              ))}
            </div>
          )}
        </div>
      );
    };

    const SettingsView = () => {
      const { isDark, toggleTheme } = useContext(ThemeContext);
      const [floatingEnabled, setFloatingEnabled] = useState(false);
      const [hasFloatingPermission, setHasFloatingPermission] = useState(false);

      // 检查悬浮窗状态
      useEffect(() => {
        if (window.AndroidInterface && window.AndroidInterface.checkFloatingWindowStatus) {
          const status = window.AndroidInterface.checkFloatingWindowStatus();
          try {
            const parsed = JSON.parse(status);
            setFloatingEnabled(parsed.enabled);
            setHasFloatingPermission(parsed.hasPermission);
          } catch (e) { }
        }
      }, []);

      const handleFloatingToggle = () => {
        if (!hasFloatingPermission) {
          // 没有权限，跳转到系统设置
          if (window.AndroidInterface && window.AndroidInterface.requestFloatingWindowPermission) {
            window.AndroidInterface.requestFloatingWindowPermission();
          }
        } else {
          // 切换开关
          const newState = !floatingEnabled;
          setFloatingEnabled(newState);
          if (window.AndroidInterface && window.AndroidInterface.setFloatingWindowEnabled) {
            window.AndroidInterface.setFloatingWindowEnabled(newState);
          }
        }
      };

      const handleLogout = () => {
        if (window.AndroidInterface && window.AndroidInterface.logout) {
          window.AndroidInterface.logout();
        } else {
          console.log("Logout clicked (AndroidInterface not found)");
        }
      };

      return (
        <div className="space-y-4 pb-28">
          <div className="flex justify-between items-end mb-6 px-2">
            <h1 className={`text-3xl font-bold transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>设置</h1>
          </div>

          {/* 悬浮窗设置 */}
          <GlassCard>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-full bg-gradient-to-br from-cyan-500 to-emerald-500`}>
                  <Zap className="w-5 h-5 text-white" />
                </div>
                <div>
                  <span className={`font-medium block ${isDark ? 'text-white' : 'text-slate-900'}`}>悬浮窗助手</span>
                  <span className={`text-xs ${hasFloatingPermission ? (isDark ? 'text-emerald-400' : 'text-emerald-600') : (isDark ? 'text-amber-400' : 'text-amber-600')}`}>
                    {hasFloatingPermission ? '已授权' : '点击授权权限'}
                  </span>
                </div>
              </div>
              <button
                onClick={handleFloatingToggle}
                className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${floatingEnabled && hasFloatingPermission ? 'bg-emerald-500' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${floatingEnabled && hasFloatingPermission ? 'translate-x-6' : 'translate-x-0'}`} />
              </button>
            </div>
            {floatingEnabled && hasFloatingPermission && (
              <div className={`mt-3 pt-3 border-t ${isDark ? 'border-white/10' : 'border-slate-200'}`}>
                <p className={`text-xs ${isDark ? 'text-white/50' : 'text-slate-500'}`}>
                  退出应用后悬浮球将自动显示，支持截图、区域选择、链接识别等功能
                </p>
              </div>
            )}
          </GlassCard>

          {/* 深色模式 */}
          <GlassCard>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className={`p-2 rounded-full ${isDark ? 'bg-white/10' : 'bg-slate-100'}`}>
                  {isDark ? <Moon className="w-5 h-5 text-white" /> : <Sun className="w-5 h-5 text-amber-500" />}
                </div>
                <span className={`font-medium ${isDark ? 'text-white' : 'text-slate-900'}`}>深色模式</span>
              </div>
              <button
                onClick={toggleTheme}
                className={`w-12 h-6 rounded-full p-1 transition-colors duration-300 ${isDark ? 'bg-emerald-500' : 'bg-slate-300'}`}
              >
                <div className={`w-4 h-4 rounded-full bg-white shadow-sm transition-transform duration-300 ${isDark ? 'translate-x-6' : 'translate-x-0'}`} />
              </button>
            </div>
          </GlassCard>

          <GlassCard>
            <button onClick={handleLogout} className="w-full flex items-center gap-3 p-2 text-red-500 font-medium">
              <LogOut className="w-5 h-5" />
              退出登录
            </button>
          </GlassCard>
        </div>
      );
    };

    // --- 全局悬浮组件 (FAB & Nav) ---

    const CaptureModal = ({ isOpen, onClose }) => {
      const { isDark } = useContext(ThemeContext);

      if (!isOpen) return null;
      return (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          className="fixed inset-0 z-50 flex items-end justify-center p-4"
          onClick={onClose}
        >
          {/* Backdrop */}
          <div className="absolute inset-0 bg-black/20 backdrop-blur-md transition-opacity" />

          <motion.div
            initial={{ y: "110%" }}
            animate={{ y: 0 }}
            exit={{ y: "110%" }}
            transition={{ type: "spring", damping: 30, stiffness: 400 }}
            className={`
                  w-full max-w-md relative z-10 rounded-[2.5rem] p-6 pb-8 border shadow-2xl
                  ${isDark
                ? 'bg-[#09090b] border-emerald-500/20'
                : 'bg-white border-white/40'
              }
                `}
            onClick={e => e.stopPropagation()}
          >
            <div className={`w-12 h-1.5 rounded-full mx-auto mb-8 ${isDark ? 'bg-white/10' : 'bg-slate-200'}`} />

            <h3 className={`text-xl font-bold mb-8 text-center transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
              快速采集
            </h3>

            <div className="grid grid-cols-3 gap-6">
              {[
                { icon: LinkIcon, label: "链接", color: "from-cyan-400 to-cyan-600" },
                { icon: ImageIcon, label: "扫描", color: "from-emerald-500 to-teal-500" },
                { icon: Mic, label: "语音", color: "from-orange-500 to-red-500" },
              ].map((item, idx) => (
                <button key={idx} className="flex flex-col items-center gap-4 group">
                  <div className={`
                         w-18 h-18 w-full aspect-square rounded-[1.5rem] flex items-center justify-center text-white shadow-xl 
                         bg-gradient-to-br ${item.color}
                         group-active:scale-95 transition-all duration-200 ring-4 ring-transparent group-hover:ring-white/10
                       `}>
                    <item.icon className="w-8 h-8" />
                  </div>
                  <span className={`text-sm font-medium transition-colors ${isDark ? 'text-white/60' : 'text-slate-500'}`}>
                    {item.label}
                  </span>
                </button>
              ))}
            </div>

            {/* Smart Paste Hint */}
            <div className={`
                  mt-10 p-4 rounded-2xl border flex items-center gap-3
                  ${isDark ? 'bg-white/5 border-white/5' : 'bg-slate-50 border-slate-100'}
                `}>
              <div className="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center">
                <Zap className="w-4 h-4 text-emerald-500" fill="currentColor" />
              </div>
              <div className="flex-1">
                <p className={`text-xs font-semibold ${isDark ? 'text-white' : 'text-slate-900'}`}>检测到剪贴板内容</p>
                <p className={`text-[10px] ${isDark ? 'text-white/50' : 'text-slate-500'}`}>"https://arxiv.org/abs/2106.09685"</p>
              </div>
              <button className="text-xs font-bold text-blue-500 bg-blue-500/10 px-3 py-1.5 rounded-lg">添加</button>
            </div>
          </motion.div>
        </motion.div>
      );
    };

    const NavBar = ({ activeTab, setActiveTab, onCapture }) => {
      const { isDark } = useContext(ThemeContext);

      const NavButton = ({ id, icon: Icon, label }) => {
        const isActive = activeTab === id;
        return (
          <button
            onClick={() => setActiveTab(id)}
            className="flex flex-col items-center justify-center gap-1 w-14 h-full relative"
          >
            <div className={`transition-all duration-500 ease-out transform ${isActive
              ? (isDark ? 'text-white translate-y-0 scale-110' : 'text-slate-900 translate-y-0 scale-110')
              : (isDark ? 'text-white/30 hover:text-white/50 translate-y-1' : 'text-slate-400 hover:text-slate-600 translate-y-1')
              }`}>
              <Icon className="w-6 h-6" strokeWidth={isActive ? 2.5 : 2} />
            </div>
            <span className={`text-[10px] transition-colors duration-300 ${isActive ? (isDark ? 'text-white' : 'text-slate-900') : 'text-transparent'}`}>{label}</span>
          </button>
        );
      };

      return (
        <div className="fixed bottom-0 w-full max-w-md px-6 pb-6 pt-10 z-40 pointer-events-none">
          {/* Gradient Fade Mask */}
          <div className={`absolute inset-x-0 bottom-0 h-32 bg-gradient-to-t transition-colors duration-500 pointer-events-none ${isDark ? 'from-black via-black/90 to-transparent' : 'from-[#F2F2F7] via-[#F2F2F7]/90 to-transparent'
            }`} />

          <div className={`
                relative h-20 rounded-[2.5rem] flex items-center justify-between px-2 pointer-events-auto
                backdrop-blur-2xl border transition-all duration-500
                ${isDark
              ? 'bg-[#1c1c1e]/80 border-white/10 shadow-2xl shadow-black/50'
              : 'bg-white/80 border-white/50 shadow-2xl shadow-slate-300/50'
            }
              `}>
            <div className="flex flex-1 justify-around">
              <NavButton id="home" icon={Home} label="首页" />
              <NavButton id="papers" icon={BookOpen} label="论文" />
            </div>

            {/* Central FAB */}
            <div className="relative -top-8 mx-2">
              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                onClick={onCapture}
                className={`
                      w-18 h-18 rounded-full flex items-center justify-center text-white shadow-lg relative z-50 group
                      bg-gradient-to-tr from-emerald-400 via-teal-500 to-cyan-500
                      border-[6px] transition-colors duration-500
                      ${isDark ? 'border-[#09090b] shadow-emerald-500/20' : 'border-[#F2F2F7] shadow-lg'}
                    `}
              >
                <Plus className="w-8 h-8 group-hover:rotate-90 transition-transform duration-300" />
              </motion.button>

              {/* Breathing Glow */}
              <div className="absolute inset-0 bg-emerald-500 rounded-full blur-xl opacity-40 animate-pulse -z-10 top-2" />
            </div>

            <div className="flex flex-1 justify-around">
              <NavButton id="competitions" icon={Trophy} label="竞赛" />
              <NavButton id="settings" icon={Settings} label="设置" />
            </div>
          </div>
        </div>
      );
    };

    // --- App Entrance ---

    const App = () => {
      const [activeTab, setActiveTab] = useState('home');
      const [isCaptureOpen, setIsCaptureOpen] = useState(false);
      const [isDark, setIsDark] = useState(false); // Default to Light Mode per requirement
      const [papers, setPapers] = useState([]);
      const [competitions, setCompetitions] = useState([]);

      const toggleTheme = () => setIsDark(!isDark);

      // Data Listeners
      useEffect(() => {
        const handlePapers = (e) => setPapers(e.detail);
        const handleCompetitions = (e) => setCompetitions(e.detail);

        window.addEventListener('papers-updated', handlePapers);
        window.addEventListener('competitions-updated', handleCompetitions);

        // Request initial data
        if (window.AndroidInterface && window.AndroidInterface.requestData) {
          window.AndroidInterface.requestData();
        }

        return () => {
          window.removeEventListener('papers-updated', handlePapers);
          window.removeEventListener('competitions-updated', handleCompetitions);
        };
      }, []);

      // Status Bar
      const StatusBar = () => (
        <div className={`flex justify-between items-center px-6 pt-6 pb-3 text-xs font-medium sticky top-0 z-50 transition-colors duration-500 ${isDark ? 'text-white' : 'text-slate-900'}`}>
          <span>9:41</span>

          <div className="flex gap-1.5 items-center">
            <div className={`w-4 h-2.5 rounded-[1px] transition-colors duration-500 ${isDark ? 'bg-white' : 'bg-slate-900'}`} />
            <div className={`w-0.5 h-2.5 rounded-[1px] transition-colors duration-500 ${isDark ? 'bg-white/30' : 'bg-slate-900/30'}`} />
          </div>
        </div>
      );

      return (
        <ThemeContext.Provider value={{ isDark, toggleTheme }}>
          <div className={`h-full flex flex-col overflow-hidden font-sans transition-colors duration-700 ease-in-out ${isDark ? 'bg-[#09090b]' : 'bg-[#F2F2F7]'}`}>

            {/* 动态背景层 (Dynamic Ambient Background) */}
            <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
              {/* Tech Grid Overlay */}
              <div className={`absolute inset-0 z-0 transition-opacity duration-1000 ${isDark ? 'opacity-[0.15]' : 'opacity-[0.03]'}`}
                style={{
                  backgroundImage: `linear-gradient(${isDark ? '#10B981' : '#000'} 1px, transparent 1px), linear-gradient(90deg, ${isDark ? '#10B981' : '#000'} 1px, transparent 1px)`,
                  backgroundSize: '40px 40px',
                  transform: 'perspective(500px) rotateX(60deg) translateY(-100px) scale(2)'
                }}
              >
                <div className="absolute inset-0 animate-grid" />
              </div>

              {/* Noise Texture */}
              <div className="absolute inset-0 opacity-[0.05] bg-[url('https://grainy-gradients.vercel.app/noise.svg')] mix-blend-overlay" />

              {/* Dark Mode Aurora */}
              <motion.div
                animate={{ opacity: isDark ? 1 : 0 }}
                transition={{ duration: 0.8 }}
                className="absolute inset-0"
              >
                <div className="absolute top-[-20%] left-[-20%] w-[600px] h-[600px] bg-emerald-500/20 rounded-full blur-[120px] mix-blend-screen" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-teal-500/20 rounded-full blur-[100px] mix-blend-screen" />
              </motion.div>

              {/* Light Mode Holographic Gradients */}
              <motion.div
                animate={{ opacity: isDark ? 0 : 1 }}
                transition={{ duration: 0.8 }}
                className="absolute inset-0"
              >
                <div className="absolute top-[-20%] left-[-10%] w-[600px] h-[600px] bg-emerald-100/60 rounded-full blur-[100px] mix-blend-multiply" />
                <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-cyan-100/60 rounded-full blur-[120px] mix-blend-multiply" />
              </motion.div>
            </div>

            <div className="w-full h-full relative z-10 flex flex-col">
              <StatusBar />

              <main className="flex-1 overflow-y-auto px-6 pt-2 scrollbar-hide pb-28">
                <AnimatePresence mode="wait">
                  {activeTab === 'home' && (
                    <motion.div
                      key="home"
                      initial={{ opacity: 0, scale: 0.95 }}
                      animate={{ opacity: 1, scale: 1 }}
                      exit={{ opacity: 0, scale: 1.05 }}
                      transition={{ duration: 0.3 }}
                    >
                      <HomeView papers={papers} competitions={competitions} />
                    </motion.div>
                  )}
                  {activeTab === 'papers' && (
                    <motion.div
                      key="papers"
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: -20 }}
                      transition={{ duration: 0.3 }}
                    >
                      <PapersView papers={papers} />
                    </motion.div>
                  )}
                  {activeTab === 'settings' && (
                    <motion.div
                      key="settings"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <SettingsView />
                    </motion.div>
                  )}
                  {activeTab === 'competitions' && (
                    <motion.div
                      key="competitions"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      transition={{ duration: 0.3 }}
                    >
                      <CompetitionsView competitions={competitions} />
                    </motion.div>
                  )}
                </AnimatePresence>
              </main>

              <NavBar
                activeTab={activeTab}
                setActiveTab={setActiveTab}
                onCapture={() => setIsCaptureOpen(true)}
              />

              <AnimatePresence>
                {isCaptureOpen && <CaptureModal isOpen={isCaptureOpen} onClose={() => setIsCaptureOpen(false)} />}
              </AnimatePresence>

            </div>
          </div>
        </ThemeContext.Provider>
      );
    };

    const root = window.ReactDOM.createRoot(document.getElementById('root'));

    // Wait for deps if needed, but module script runs before this usually?
    // Actually module script is defer by default. text/babel is also defer.
    // We can check if React is ready.

    const render = () => {
      if (window.React && window.ReactDOM && window.FramerMotion && window.LucideReact) {
        root.render(<App />);
        // Smooth transition: hide loader, show content
        requestAnimationFrame(() => {
          document.getElementById('root').classList.add('loaded');
          document.getElementById('loading-screen').classList.add('hidden');
        });
      } else {
        setTimeout(render, 50);
      }
    };

    render();

  </script>
</body>

</html>